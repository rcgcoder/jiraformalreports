<!DOCTYPE html>
<html lang="en">
 <head>
<!--       <link rel="stylesheet" href="//aui-cdn.atlassian.com/aui-adg/5.9.12/css/aui.min.css" media="all">
	 <script type="text/javascript" src="js/rcglibs/RCGZippedWebApp.js"></script>
-->	 
	 <script type="text/javascript">
	 	function getUrlParameter(sParam) {
		    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
		        sURLVariables = sPageURL.split('&'),
		        sParameterName,
		        i;

		    for (i = 0; i < sURLVariables.length; i++) {
		        sParameterName = sURLVariables[i].split('=');
		        if (sParameterName[0] === sParam) {
		            return sParameterName[1] === undefined ? true : sParameterName[1];
		        }
		    }
		};
		
		function getLastCommit(repo,callback){
	  		 var xhr = new XMLHttpRequest();
			 var sRepoUrl="https://api.github.com/repos/"+repo+"/commits/master";
			 xhr.open('GET', sRepoUrl, true);
			 xhr.responseType = 'json';
		     xhr.onerror=function(){alert("Error getting last commit");
			 xhr.onload = function(e) {
				  if (this.status == 200) {
						var lastCommit=this.response;
						var sCommitLongId=lastCommit.sha;
						var sCommitShortId=sCommitLongId.substring(0,8);
						commitId=sCommitShortId;
						callback(commitId);
				  } else {
					  self.loadError({target:{src:sUrl}});			  
				  }
			 };
			 xhr.send();
		 }
	     function getJavaScriptFile(sUrl,callback){
				var xhr = new XMLHttpRequest();
				xhr.open('GET', sUrl, true);
				xhr.onerror=function(){console.log("Error getting:"+ sUrl);};
				xhr.onload = function(e) {
				  if (this.status == 200) {
					  console.log("Downloaded "+sUrl);
					  var ct=self.getContentType(xhr);
					  callback(this.responseText);
				  } else {
					  console.log("Error downloading "+sUrl);
				  }
				};
				xhr.send();
		 }	
	     function loadJavaScriptFile(jsContent,callback){
				var oHead=(document.head || document.getElementsByTagName("head")[0]);
				var oScript = document.createElement("script");
				oScript.type = "text\/javascript";
				oScript.onerror = function(){console.log("Error applying javascrip");};
    			oHead.appendChild(oScript);
				oScript.innerHTML = jsContent;
				callback();
		 }	

	  </script>
</head>
 <body> 
     <section id="content" class="ac-content">
         <div class="aui-page-header" >
         	 <iFrame id="JFR_GITHUB_LOGIN"></iFrame>
             <div id="JFR_Main_DIV" class="aui-page-header-main">
                 <h1>Jira Formal ("Master") Reports Plugin</h1>
                 <img id="jrfSplash"src="img/splash.jpg">
				 <span id="jfrSpan" class="jfrSpan"> Loading Plugin..... </span>
             </div>
         </div>
     </section>

     <script id="connect-loader" data-options="sizeToParent:true;">
         (function() {
        	 var appParameters={};
			 var vXdm=getUrlParameter('xdm_e');
			 var vCp=getUrlParameter('cp');
			 if ((typeof vXdm!=="undefined")&&
				(typeof vCp!=="undefined")){
				 var baseUrl =  vXdm+vCp; 
				 var options = document.getElementById('connect-loader').getAttribute('data-options');

				 var script = document.createElement("script");
				 script.src = baseUrl + '/atlassian-connect/all.js';

				 if(options) {
					 script.setAttribute('data-options', options);
				 }

				 document.getElementsByTagName("head")[0].appendChild(script);
				 var objJason = JSON.parse(name);
				 var api=objJason.api;
				 var projectKey=objJason.options.productContext["project.key"];
				 appParameters["ProjectKey"]=projectKey;
				 appParameters["urlBase"]=baseUrl;
		     } else {
				var sUrl=document.url;
				var sProjectKey=getUrlParameter("idProject");
				var urlBase=getUrlParameter("urlBase");
				appParameters["ProjectKey"]=sProjectKey;
			    appParameters["urlBase"]=urlBase;
			 }

			 var githubCode=getUrlParameter("code");
			 var rootPath="https://cdn.rawgit.com";
			 var sRepo="rcgcoder/jiraformalreports";
			 var commitId="";
			 var sZipWebAppClass="js/rcglibs/RCGZippedWebApp.js";
			 getLastCommit(sRepo,function(sCommitId){
				 commitId=sCommitId;
				 var sUrlJs=rootPath+"/"+sRepo+"/"+commitId+"/common/rcglibs/RCGZippedWebApp.js";
				 getJavaScriptFile(sUrlJs,function(jsContent){
					 loadJavaScriptFile(jsContent,function(){
						 var zipApp=new RCGZippedApp();
//						 zipApp.localStorageMaxSize=200*1024*1024;
						 zipApp.rootPath=rootPath;
						 zipApp.prependPath="common";
						 zipApp.useGitHub(sRepo,"master",githubCode);
						 zipApp.github.commitId=commitId;
			 			 zipApp.addDeployZip("ZippedWebApp/jiraformalreports.zip","jiraformalreports-master/common/");
						 zipApp.addDeployZip("ZippedWebApp/aui-flat-pack.zip");
						 zipApp.setHtmlContainerID("JFR_Main_DIV");
						 zipApp.run();
					 });
				 });
			 });		
			 
					
					

         })();
     </script>
 </body>
</html>